"use strict";var e=require("wind-eventbus-miniprogram");function t(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function i(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var c=require("./utils"),o=c.weightTypeTools,r=c.weightReg,a=c.errorToast,s=c.ab2Ascii,u=c.tareBuffer,d=c.zeroBuffer,v=c.debug,f=c.setDeviceCache,l=c.getDeviceCache,h=c.noop,g=function(){function c(){var i=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),n(this,"silentConnect",(function(){var t=l(),n=t.deviceId,c=t.deviceName;n&&i.connectionWeight(n,c,!1).then((function(){e.$fxEventBus.emit("weightConnect",{deviceId:n,deviceName:c,connected:!0})}))})),n(this,"startBluetoothDevicesDiscovery",(function(){return new Promise((function(e){i.stopScanWeight().then((function(){v("搜索蓝牙设备"),i.scanDeviceState?e():wx.startBluetoothDevicesDiscovery({allowDuplicatesKey:!0,success:function(t){v("搜索蓝牙设备-成功",t),i.scanDeviceState=!0,e()},fail:function(e){console.log(e),a("搜索电子秤失败!")}})}))}))})),n(this,"onBluetoothDeviceFound",(function(e){i.onBluetoothDeviceFoundCallBack=function(t){var n=i.getScales(t.devices);n.length>0&&(n=n.filter((function(e){return!~i.devicesList.findIndex((function(t){return t.deviceId===e.deviceId}))}))).length>0&&(i.devicesList=i.devicesList.concat(n),e(i.devicesList))},wx.onBluetoothDeviceFound(i.onBluetoothDeviceFoundCallBack)})),n(this,"onOffBluetoothDeviceFound",(function(){wx.offBluetoothDeviceFound(i.onBluetoothDeviceFoundCallBack)})),n(this,"connectionWeightHandler",(function(e){return function(t,n){return new Promise((function(c,o){v("电子秤建立连接",t),wx.createBLEConnection({deviceId:t,success:function(e){v("电子秤建立连接-成功",e),i.deviceId=t,i.deviceName=n,f(t,n),c()},fail:function(t){e||a("无法连接!"),o(t)}})}))}})),n(this,"createWeightService",(function(e){return function(){return new Promise((function(t,n){v("电子秤建立服务连接",i.deviceId),wx.getBLEDeviceServices({deviceId:i.deviceId,success:function(e){v("电子秤建立服务连接-成功"),v("device services:",e.services);var n=e.services[0].uuid;i.serviceId=n,t(n)},fail:function(t){e||a("无法建立服务!"),n(t)}})}))}})),n(this,"getWeightCharacteristics",(function(e){return function(){return new Promise((function(t,n){v("获取电子秤服务描述"),wx.getBLEDeviceCharacteristics({deviceId:i.deviceId,serviceId:i.serviceId,success:function(e){v("获取电子秤服务描述-成功"),v("device getBLEDeviceCharacteristics:",e.characteristics);var n=e.characteristics.find((function(e){return!!e.properties.notify})),c=e.characteristics.find((function(e){return!!e.properties.write}));n&&c?(i.notifyCharacteristicId=n.uuid,i.writeCharacteristicId=c.uuid,t()):a("无法连接服务!")},fail:function(t){e||a("无法连接服务!"),n(t)}})}))}})),n(this,"notifyWeight",(function(e){v("订阅通知"),wx.notifyBLECharacteristicValueChange({state:!0,deviceId:i.deviceId,serviceId:i.serviceId,characteristicId:i.notifyCharacteristicId,success:function(c){v("订阅通知成功"),v("notifyBLECharacteristicValueChange success",c),wx.onBLECharacteristicValueChange((function(c){if(c.value){var o=i.normalizationWeightInfo(s(c.value));o&&e(function(e){for(var i=1;i<arguments.length;i++){var c=null!=arguments[i]?arguments[i]:{};i%2?t(Object(c),!0).forEach((function(t){n(e,t,c[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(c)):t(Object(c)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(c,t))}))}return e}({id:c.characteristicId},o))}}))},fail:function(e){console.log(e),a("无法订阅服务!")}})})),n(this,"onBLEConnectionStateChange",(function(){wx.onBLEConnectionStateChange((function(t){t.deviceId!==i.deviceId||t.connected||(i.deviceName="",i.deviceId="",e.$fxEventBus.emit("weightConnect",{connected:!1}))}))})),n(this,"closeWeight",(function(e){return new Promise((function(t){wx.closeBLEConnection({deviceId:e,success:function(e){t(e)}})}))})),this.ready=null,this.scanDeviceState=!1,this.devicesList=[],this.deviceName="",this.deviceId="",this.serviceId="",this.writeCharacteristicId="",this.notifyCharacteristicId="",this.onBluetoothDeviceFoundCallBack=h}var g,I,w;return g=c,I=[{key:"init",value:function(){var e=this;return new Promise((function(t){v("开启蓝牙模块"),e.onBLEConnectionStateChange(),e.ready?t(e.ready):wx.openBluetoothAdapter({success:function(i){v("开启蓝牙模块-成功",i),e.ready=i,t(i)},fail:function(e){console.log(e),a("蓝牙未开启!")}})}))}},{key:"scanWeight",value:function(){var e=this;return new Promise((function(t){e.startBluetoothDevicesDiscovery().then((function(){e.devicesList=e.deviceId?[{deviceId:e.deviceId,name:e.deviceName}]:[],t({devicesList:e.devicesList,findWeightFn:e.onBluetoothDeviceFound})}))}))}},{key:"getScales",value:function(e){return e.filter((function(e){return r.test(e.name)}))}},{key:"stopScanWeight",value:function(){var e=this;return new Promise((function(t){e.scanDeviceState?wx.stopBluetoothDevicesDiscovery({success:function(i){v("停止搜索蓝牙设备"),e.onOffBluetoothDeviceFound(),e.scanDeviceState=!1,t()}}):t()}))}},{key:"connectionWeight",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.connectionWeightHandler(i)(e,t).then(this.createWeightService(i)).then(this.getWeightCharacteristics(i))}},{key:"normalizationWeightInfo",value:function(e){return v(e),o.is("stable")(e)?o.normalizationValue("stable")(e):o.is("unstable")(e)?o.normalizationValue("unstable")(e):o.is("tare")(e)?o.normalizationValue("tare")(e):o.is("OK")(e)?o.normalizationValue("OK")(e):o.is("OkStable")(e)?o.normalizationValue("OkStable")(e):o.is("OKTare")(e)?o.normalizationValue("OKTare")(e):void console.log("接收到无法处理的数据")}},{key:"sendTareCode",value:function(){var e=this;return new Promise((function(t){e.writeCharacteristicId?(v("设置去皮指令"),wx.writeBLECharacteristicValue({deviceId:e.deviceId,serviceId:e.serviceId,characteristicId:e.writeCharacteristicId,value:u,success:function(e){v("发送去皮指令成功",e),t()},fail:function(e){console.log(e),a("设置去皮失败!")}})):a("设置去皮失败!")}))}},{key:"sendZeroCode",value:function(){var e=this;return new Promise((function(t){e.writeCharacteristicId?(v("设置置零指令"),wx.writeBLECharacteristicValue({deviceId:e.deviceId,serviceId:e.serviceId,characteristicId:e.writeCharacteristicId,value:d,success:function(e){v("发送置零指令成功",e),t()},fail:function(e){console.log(e),a("设置置零失败!")}})):a("设置置零失败!")}))}},{key:"getScanState",value:function(){return this.scanDeviceState}},{key:"getDevicesList",value:function(){return this.devicesList}},{key:"getDeviceConnect",value:function(){return{deviceName:this.deviceName,deviceId:this.deviceId}}}],I&&i(g.prototype,I),w&&i(g,w),Object.defineProperty(g,"prototype",{writable:!1}),c}();module.exports={$fxWeight:new g};
