"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=e(require("wind-eventbus-miniprogram"));function n(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var i,r,c=[],o=!0,a=!1;try{for(n=n.call(e);!(o=(i=n.next()).done)&&(c.push(i.value),!t||c.length!==t);o=!0);}catch(e){a=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(a)throw r}}return c}(e,t)||a(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||a(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e,t){if(e){if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var s=!0,l="BJ02",f={stable:{id:"stable",typeReg:/^Wa/,valueReg:/^Wa(\-)?(\d*)B([a-zA-Z])B([a-zA-Z])/,normalizationValue:function(e){var t=c(e.match(this.valueReg),5),n=t[0],i=t[1],r=t[2],o=t[3],a=t[4];return{type:this.id,instructStr:n,weight:d(r,i),zero:"Z"===o,tare:"T"===a}}},unstable:{id:"unstable",typeReg:/^Wn/,valueReg:/^Wn(\-)?(\d*)/,normalizationValue:function(e){var t=c(e.match(this.valueReg),3),n=t[0],i=t[1],r=t[2];return{type:this.id,instructStr:n,weight:d(r,i)}}},tare:{id:"tare",typeReg:/^P/,valueReg:/^P(\-)?(\d*)/,normalizationValue:function(e){var t=c(e.match(this.valueReg),3),n=t[0],i=t[1],r=t[2];return{type:this.id,instructStr:n,weight:d(r,i)}}},OK:{id:"OK",typeReg:/^OK$/,normalizationValue:function(e){return{type:this.id}}},OkStable:{id:"OkStable",typeReg:/^OKWa/,valueReg:/^OKWa(\-)?(\d*)B([a-zA-Z])B([a-zA-Z])/,normalizationValue:function(e){var t=c(e.match(this.valueReg),5),n=t[0],i=t[1],r=t[2],o=t[3],a=t[4];return{type:this.id,instructStr:n,weight:d(r,i),zero:"Z"===o,tare:"T"===a}}},OKTare:{id:"OKTare",typeReg:/^OKP/,valueReg:/^OKP(\-)?(\d*)/,normalizationValue:function(e){var t=c(e.match(this.valueReg),3),n=t[0],i=t[1],r=t[2];return{type:this.id,instructStr:n,weight:d(r,i)}}}},d=function(e,t){return e?((e=e.split("").reverse()).splice(3,0,"."),e=e.join(""),t&&(e="-".concat(e)),isNaN(Number(e))?0:Number(e)):0},v=function(e){var t=new ArrayBuffer(e.length),n=new DataView(t);return o(e).forEach((function(e,t){n.setUint8(t,e.charCodeAt())})),t},h={weightTypeTools:{is:function(e){return function(t){return f[e].typeReg.test(t)}},normalizationValue:function(e){return function(t){return f[e].normalizationValue(t)}}},weightReg:/^BR/,errorToast:function(e){wx.showToast({title:e,icon:"error",duration:2e3})},successToast:function(e){wx.showToast({title:e,icon:"success",duration:2e3})},ab2Ascii:function(e){return Array.prototype.map.call(new Uint8Array(e),(function(e){return String.fromCharCode(e)})).join("")},weightStr2Num:d,tareBuffer:v("BJ01"),zeroBuffer:v(l),debug:function(){var e;s&&(e=console).log.apply(e,arguments)},setDebugFlag:function(e){s=e},setDeviceCache:function(e,t){wx.setStorageSync("fx-device","".concat(e,"$$").concat(t))},getDeviceCache:function(){var e=wx.getStorageSync("fx-device");if(e){var t=c(e.split("$$"),2);return{deviceId:t[0],deviceName:t[1]}}return{}},noop:function(){}},g=t.default,y=h.weightTypeTools,p=h.weightReg,w=h.errorToast,m=h.ab2Ascii,b=h.tareBuffer,I=h.zeroBuffer,C=h.debug,B=h.setDebugFlag,D=h.setDeviceCache,O=h.noop,S=g.$fxCreateEventBus(),P={$fxWeight:new(function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r(this,"startBluetoothDevicesDiscovery",(function(){return new Promise((function(e){t.stopScanWeight().then((function(){C("搜索蓝牙设备"),t.scanDeviceState?e():wx.startBluetoothDevicesDiscovery({allowDuplicatesKey:!0,success:function(n){C("搜索蓝牙设备-成功",n),t.scanDeviceState=!0,e()},fail:function(e){console.log(e),w("搜索电子秤失败!")}})}))}))})),r(this,"onBluetoothDeviceFound",(function(e){t.onBluetoothDeviceFoundCallBack=function(n){var i=t.getScales(n.devices);i.length>0&&(i=i.filter((function(e){return!~t.devicesList.findIndex((function(t){return t.deviceId===e.deviceId}))}))).length>0&&(t.devicesList=t.devicesList.concat(i),e(t.devicesList))},wx.onBluetoothDeviceFound(t.onBluetoothDeviceFoundCallBack)})),r(this,"onOffBluetoothDeviceFound",(function(){wx.offBluetoothDeviceFound(t.onBluetoothDeviceFoundCallBack)})),r(this,"connectionWeightHandler",(function(e){return function(n,i){return new Promise((function(r,c){C("电子秤建立连接",n),wx.createBLEConnection({deviceId:n,success:function(e){C("电子秤建立连接-成功",e),t.deviceId=n,t.deviceName=i,D(n,i),r()},fail:function(t){e||w("无法连接!"),c(t)}})}))}})),r(this,"createWeightService",(function(e){return function(){return new Promise((function(n,i){C("电子秤建立服务连接",t.deviceId),wx.getBLEDeviceServices({deviceId:t.deviceId,success:function(e){C("电子秤建立服务连接-成功"),C("device services:",e.services);var i=e.services[0].uuid;t.serviceId=i,n(i)},fail:function(t){e||w("无法建立服务!"),i(t)}})}))}})),r(this,"getWeightCharacteristics",(function(e){return function(){return new Promise((function(n,i){C("获取电子秤服务描述"),wx.getBLEDeviceCharacteristics({deviceId:t.deviceId,serviceId:t.serviceId,success:function(e){C("获取电子秤服务描述-成功"),C("device getBLEDeviceCharacteristics:",e.characteristics);var i=e.characteristics.find((function(e){return!!e.properties.notify})),r=e.characteristics.find((function(e){return!!e.properties.write}));i&&r?(t.notifyCharacteristicId=i.uuid,t.writeCharacteristicId=r.uuid,n()):w("无法连接服务!")},fail:function(t){e||w("无法连接服务!"),i(t)}})}))}})),r(this,"notifyWeight",(function(e){C("订阅通知"),wx.notifyBLECharacteristicValueChange({state:!0,deviceId:t.deviceId,serviceId:t.serviceId,characteristicId:t.notifyCharacteristicId,success:function(i){C("订阅通知成功"),C("notifyBLECharacteristicValueChange success",i),wx.onBLECharacteristicValueChange((function(i){if(i.value){var c=t.normalizationWeightInfo(m(i.value));c&&e(function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?n(Object(i),!0).forEach((function(t){r(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({id:i.characteristicId},c))}}))},fail:function(e){console.log(e),w("无法订阅服务!")}})})),r(this,"doBLEConnectionStateChange",(function(e){e.deviceId!==t.deviceId||e.connected||(t.deviceName="",t.deviceId="",S.emit("weightConnect",{connected:!1}))})),r(this,"closeWeight",(function(e){return new Promise((function(t){wx.closeBLEConnection({deviceId:e,success:function(e){t(e)}})}))})),r(this,"onWeightConnectChange",(function(e,t){S.on("weightConnect",e,t)})),r(this,"offWeightConnectChange",(function(e){S.remove("weightConnect",e)})),this.ready=null,this.scanDeviceState=!1,this.devicesList=[],this.deviceName="",this.deviceId="",this.serviceId="",this.writeCharacteristicId="",this.notifyCharacteristicId="",this.onBluetoothDeviceFoundCallBack=O}var t,c,o;return t=e,c=[{key:"init",value:function(){var e=this;return new Promise((function(t){C("开启蓝牙模块"),e.ready?t(e.ready):wx.openBluetoothAdapter({success:function(n){C("开启蓝牙模块-成功",n),e.ready=n,t(n)},fail:function(e){console.log(e),w("蓝牙未开启!")}})}))}},{key:"scanWeight",value:function(){var e=this;return new Promise((function(t){e.startBluetoothDevicesDiscovery().then((function(){e.devicesList=e.deviceId?[{deviceId:e.deviceId,name:e.deviceName}]:[],t({devicesList:e.devicesList,findWeightFn:e.onBluetoothDeviceFound})}))}))}},{key:"getScales",value:function(e){return e.filter((function(e){return p.test(e.name)}))}},{key:"stopScanWeight",value:function(){var e=this;return new Promise((function(t){e.scanDeviceState?wx.stopBluetoothDevicesDiscovery({success:function(n){C("停止搜索蓝牙设备"),e.onOffBluetoothDeviceFound(),e.scanDeviceState=!1,t()}}):t()}))}},{key:"connectionWeight",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.connectionWeightHandler(n)(e,t).then(this.createWeightService(n)).then(this.getWeightCharacteristics(n))}},{key:"normalizationWeightInfo",value:function(e){return C(e),y.is("stable")(e)?y.normalizationValue("stable")(e):y.is("unstable")(e)?y.normalizationValue("unstable")(e):y.is("tare")(e)?y.normalizationValue("tare")(e):y.is("OK")(e)?y.normalizationValue("OK")(e):y.is("OkStable")(e)?y.normalizationValue("OkStable")(e):y.is("OKTare")(e)?y.normalizationValue("OKTare")(e):void console.log("接收到无法处理的数据")}},{key:"sendTareCode",value:function(){var e=this;return new Promise((function(t){e.writeCharacteristicId?(C("设置去皮指令"),wx.writeBLECharacteristicValue({deviceId:e.deviceId,serviceId:e.serviceId,characteristicId:e.writeCharacteristicId,value:b,success:function(e){C("发送去皮指令成功",e),t()},fail:function(e){console.log(e),w("设置去皮失败!")}})):w("设置去皮失败!")}))}},{key:"sendZeroCode",value:function(){var e=this;return new Promise((function(t){e.writeCharacteristicId?(C("设置置零指令"),wx.writeBLECharacteristicValue({deviceId:e.deviceId,serviceId:e.serviceId,characteristicId:e.writeCharacteristicId,value:I,success:function(e){C("发送置零指令成功",e),t()},fail:function(e){console.log(e),w("设置置零失败!")}})):w("设置置零失败!")}))}},{key:"getScanState",value:function(){return this.scanDeviceState}},{key:"getDevicesList",value:function(){return this.devicesList}},{key:"getDeviceConnect",value:function(){return{deviceName:this.deviceName,deviceId:this.deviceId}}},{key:"isWeight",value:function(e){return e&&p.test(e)}},{key:"openDebug",value:function(){B(!0)}},{key:"createDeviceObj",value:function(e,t){return{name:e,deviceId:t}}}],c&&i(t.prototype,c),o&&i(t,o),Object.defineProperty(t,"prototype",{writable:!1}),e}())};module.exports=P;
